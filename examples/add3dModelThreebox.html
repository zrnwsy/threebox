<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Add a 3D model</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="../dist/threebox.js" type="text/javascript"></script>
    <link href="../dist/threebox.css" rel="stylesheet" />
    <script src="config.js"></script>
    <style>
      body,
      html {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      #map {
        width: 100%;
        height: 100%;
        margin-top: 40px;

      }

      /* #scaleSlider {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 8888;
      } */
      button{
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <button onclick="changeScale(1)">+</button>
    <button onclick="changeScale(-1)">-</button>
    <div id="map" class="map"></div>
    <!-- <div class="slider-wrap">
      <input id="scaleSlider" type="range" name="points" min="1" max="10" />
    </div> -->
    <script>
      mapboxgl.accessToken = config.accessToken;
      var map = (window.map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v11",
        zoom: 16,
        center: [-8.629134, 41.157902],
        pitch: 60,
        antialias: true, // create the gl context with MSAA antialiasing, so custom layers are antialiased
      }));
      var theModel;
      // parameters to ensure the model is georeferenced correctly on the map
      var modelOrigin = [-8.629134, 41.157902, 0];
      window.tb = new Threebox(map, map.getCanvas().getContext("webgl"), {
        defaultLights: true,
        enableSelectingObjects: true,
        enableDraggingObjects: true,
        enableRotatingObjects: true,
        enableTooltips: true,
        enableHelpTooltips: true,
      });
      function createCustomLayer(layerName, origin) {
        //create the layer
        let customLayer3D = {
          id: layerName,
          type: "custom",
          renderingMode: "3d",
          onAdd: (map, gl) => {
            // instantiate threebox
            let options = {
              type: "glb",
              obj: "../examples/models/Soldier.glb",
              // obj: "../examples/models/Soldier.glb",
              // obj: "./models/radar/34M_17.glb", //model url
              // obj: "https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf",
              units: "meters",
              scale: 100,
              anchor: "center",
              rotation: { x: 90, y: 0, z: 0 },
              maxZoom:14
						// bbox: false
            };
            function makeNaive(options) {
              let promises = [];
              for (var i = 0; i < 100; i++) {
                promises.push(
                  new Promise((resolve) => {
                    window.tb.loadObj(options, (model) => {
                      let lng = origin[0] + Math.random() * 0.4 - 0.2;
                      let lat = origin[1] + Math.random() * 0.4 - 0.2;
                      let alt = origin[2] + Math.random() * 0.4 - 0.2;
                      let obj = model.setCoords([lng, lat, alt]);
                      obj.fixedZoom = 100;
                      window.tb.add(obj);

                      if (obj.animation) {
                        // play default animation, for 10 seconds
                        let opt = { animation: 0, duration: 10000 };
                        obj.playDefault(opt);
                      }

                      getGeometryTotalLength();
                      resolve(true);
                    });
                  })
                );
              }

              Promise.all(promises).then((values) => {
                console.log("All promises finished:");
                window.tb.world.children.forEach((o) => {
                  console.log(o);
                });
              });
              map.repaint = true;
            }

            // 1. 渲染多个模型
            // makeNaive(options);

            // 2 .渲染单个模型
            window.tb.loadObj(options, (model) => {
              model.setCoords(origin);
              model.addTooltip("Your diorama model is loaded", true);
              window.tb.add(model);
              // console.log(tb, model, model.scale);
              // console.log("22222", model);
              theModel =model
            });


            window.tb.loadObj({
              type: "glb",
              obj: "../examples/models/vehicles/truck.glb",
              // obj: "../examples/models/Soldier.glb",
              // obj: "./models/radar/34M_17.glb", //model url
              // obj: "https://docs.mapbox.com/mapbox-gl-js/assets/34M_17/34M_17.gltf",
              units: "meters",
              scale: 100,
              anchor: "center",
              rotation: { x: 90, y: 0, z: 0 },
              maxZoom:14
						// bbox: false
            }, (model) => {
              model.setCoords([-8.629134, 41.155700, 0]);
              model.addTooltip("saxas", true);
              window.tb.add(model);
              // console.log(tb, model, model.scale);
              // console.log("22222", model);
              // theModel =model
            });
          },
          render: function (gl, matrix) {
            window.tb.update();
          },
        };
        return customLayer3D;
      }

      var maxZoom = 15;
		function changeScale(step) {
      // console.log(theModel)
			maxZoom = maxZoom + step;
			theModel.fixedZoom = maxZoom;
			theModel.setObjectScale(map.transform.scale);
			// console.log(theModel)
			// console.log('1----',e,api.maxZoom, map.transform.scale)
      window.tb.map.repaint = true;
		}


      map.on("style.load", function () {
        map.addLayer(
          createCustomLayer("3d-model", modelOrigin),
          "waterway-label"
        );
      });
    </script>
  </body>
</html>
